<!DOCTYPE html>
<meta charset="utf-8">

<head>
<title> Grape Leaf Mapper </title>
</head>


<style>

header {
    background-color: black;
    padding: 3px;
}

header h1 {
    margin: 0;
    color: white
}

h1 {text-align: center;}

html,
body {
  margin: 0;
  overflow: hidden;
  font: normal 15px Verdana, Arial, sans-serif;
}




    .links line {
        stroke: #999;
        stroke-opacity: 0.5;
    }
    
    .node circle {
	  pointer-events: all;
	  stroke: #777;
	  stroke-width: 1px;
	}
	

    text {
        font-size: 1em;
        font-weight: bold;
        -webkit-font-smoothing: antialiased;
    }
   

</style>
<header>
    <h1>Giotto Mapper graph on procrustes alignment of Passiflora data</h1>
    <header>

<body>
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.min.js"></script>
<script src="//labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>



<script>

// js files
// https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.min.js
// https://d3js.org/d3-scale-chromatic.v1.min.js
// http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js

// code
// https://bl.ocks.org/puzzler10/4438752bb93f45dc5ad5214efaa12e4a
// https://gist.github.com/kgeorgiou/68f864364f277720252d0329408433ae
// https://bl.ocks.org/mbostock/3355967
// https://codepen.io/renx777/pen/BmBvzL
// https://bl.ocks.org/almsuarez/4333a12d2531d6c1f6f22b74f2c57102
// https://stackoverflow.com/questions/20052964/d3-how-to-add-image-to-the-label-of-a-graph-node

// stuff for pie chart nodes

var DEFAULT_OPTIONS = {
    radius: 20,
    outerStrokeWidth: 10,
    parentNodeColor: 'blue',
    showPieChartBorder: true,
    pieChartBorderColor: 'white',
    pieChartBorderWidth: '2',
    showLabelText: false,
    labelText: 'text',
    labelColor: 'blue'
};

function getOptionOrDefault(key, options, defaultOptions) {
    defaultOptions = defaultOptions || DEFAULT_OPTIONS;
    if (options && key in options) {
        return options[key];
    }
    return defaultOptions[key];
}

function drawParentCircle(nodeElement, options) {
    var outerStrokeWidth = getOptionOrDefault('outerStrokeWidth', options);
    var radius = getOptionOrDefault('radius', options);
    var parentNodeColor = getOptionOrDefault('parentNodeColor', options);

    nodeElement.insert("circle")
        .attr("id", "parent-pie")
        .attr("r", radius)
        .attr("fill", function (d) {
            return parentNodeColor;
        })
        .attr("stroke", function (d) {
            return parentNodeColor;
        })
        .attr("stroke-width", outerStrokeWidth);
}

function drawPieChartBorder(nodeElement, options) {
    var radius = getOptionOrDefault('radius', options);
    var pieChartBorderColor = getOptionOrDefault('pieChartBorderColor', options);
    var pieChartBorderWidth = getOptionOrDefault('pieChartBorderWidth', options);

    nodeElement.insert("circle")
        .attr("r", radius)
        .attr("fill", 'transparent')
        .attr("stroke", pieChartBorderColor)
        .attr("stroke-width", pieChartBorderWidth);
}

function drawPieChart(nodeElement, percentages, options) {
    var radius = getOptionOrDefault('radius', options);
    var halfRadius = radius / 2;
    var halfCircumference = 2 * Math.PI * halfRadius;

    var percentToDraw = 0;
    for (var p in percentages) {
        percentToDraw += percentages[p].percent;

        nodeElement.insert('circle', '#parent-pie + *')
            .attr("r", halfRadius)
            .attr("fill", 'transparent')
            .style('stroke', color(percentages[p].color))
            .style('stroke-width', radius)
            .style('stroke-dasharray',
                    halfCircumference * percentToDraw / 100
                    + ' '
                    + halfCircumference);
    }
}

function drawTitleText(nodeElement, options) {
    var radius = getOptionOrDefault('radius', options);
    var text = getOptionOrDefault('labelText', options);
    var color = getOptionOrDefault('labelColor', options);

    nodeElement.append("text")
        .text(String(text))
        .attr("fill", color)
        .attr("dy", radius * 2);
}

var NodePieBuilder = {
    drawNodePie: function (nodeElement, percentages, options) {
        drawParentCircle(nodeElement, options);

        if (!percentages) return;
        drawPieChart(nodeElement, percentages, options);

        var showPieChartBorder = getOptionOrDefault('showPieChartBorder', options);
        if (showPieChartBorder) {
            drawPieChartBorder(nodeElement, options);
        }

        var showLabelText = getOptionOrDefault('showLabelText', options);
        if (showLabelText) {
            drawTitleText(nodeElement, options);
        }
    }
};

// end pie chart node stuff
    
    var svg = d3.select("body").append("svg");
        width = window.innerWidth - 5;
        height = window.innerHeight - 5;
        

    var color = d3.scaleOrdinal(d3.schemeCategory10)
      .domain([0,1,2,3,4,5,6]);

    
    const forceX = d3.forceX(width / 4 ).strength(0.05)
    const forceY = d3.forceY(height / 4).strength(0.05)
    
    

    var simulation = d3.forceSimulation()
    	    .nodes(graph.nodes);
            .force("link", d3.forceLink().id(function (d) {
                return d.id;
            }))
	    .force('x', forceX)
	    .force('y',  forceY)
	    .force("charge", d3.forceManyBody().strength(-1200))
	    .force("center", d3.forceCenter(width / 2, height / 2));
            
            
    //add tick instructions: 
    simulation.on("tick", tickActions );
    

    //add encompassing group for the zoom 
    var g = svg.append("g")
        .attr("class", "everything");
        
        
    var tooltip = d3.select("body")
	.append("div")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("width", "150px")
	.style("height", "200px")
	.style("padding", "5px")
	.style("font", "12px sans-serif")
	.style("border", "0px")
	.style("border-radius", "8px")
	.style("background", "lightsteelblue")
	.style("visibility", "hidden");

    var graph = [{"nodes": [{"id": 0, "group": 6, "node_size": 14, "heteroblasty": 0.114, "pieChart": [{"color": 4, "percent": 14.286}, {"color": 5, "percent": 14.286}, {"color": 6, "percent": 71.429}]}, {"id": 1, "group": 6, "node_size": 12, "heteroblasty": 0.187, "pieChart": [{"color": 4, "percent": 8.333}, {"color": 6, "percent": 91.667}]}, {"id": 2, "group": 6, "node_size": 12, "heteroblasty": 0.241, "pieChart": [{"color": 4, "percent": 8.333}, {"color": 5, "percent": 8.333}, {"color": 6, "percent": 83.333}]}, {"id": 3, "group": 6, "node_size": 10, "heteroblasty": 0.314, "pieChart": [{"color": 5, "percent": 10.0}, {"color": 6, "percent": 90.0}]}, {"id": 4, "group": 6, "node_size": 14, "heteroblasty": 0.403, "pieChart": [{"color": 4, "percent": 14.286}, {"color": 6, "percent": 85.714}]}, {"id": 5, "group": 6, "node_size": 2, "heteroblasty": 0.375, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 6, "group": 6, "node_size": 12, "heteroblasty": 0.448, "pieChart": [{"color": 4, "percent": 16.667}, {"color": 6, "percent": 83.333}]}, {"id": 7, "group": 6, "node_size": 2, "heteroblasty": 0.472, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 8, "group": 6, "node_size": 4, "heteroblasty": 0.557, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 9, "group": 6, "node_size": 4, "heteroblasty": 0.582, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 10, "group": 4, "node_size": 107, "heteroblasty": 0.658, "pieChart": [{"color": 4, "percent": 58.879}, {"color": 5, "percent": 16.822}, {"color": 6, "percent": 24.299}]}, {"id": 11, "group": 4, "node_size": 119, "heteroblasty": 0.72, "pieChart": [{"color": 4, "percent": 57.983}, {"color": 5, "percent": 16.807}, {"color": 6, "percent": 25.21}]}, {"id": 12, "group": 6, "node_size": 29, "heteroblasty": 0.79, "pieChart": [{"color": 4, "percent": 27.586}, {"color": 5, "percent": 6.897}, {"color": 6, "percent": 65.517}]}, {"id": 13, "group": 6, "node_size": 23, "heteroblasty": 0.878, "pieChart": [{"color": 4, "percent": 34.783}, {"color": 5, "percent": 4.348}, {"color": 6, "percent": 60.87}]}, {"id": 14, "group": 6, "node_size": 28, "heteroblasty": 0.959, "pieChart": [{"color": 4, "percent": 32.143}, {"color": 5, "percent": 7.143}, {"color": 6, "percent": 60.714}]}, {"id": 15, "group": 6, "node_size": 2, "heteroblasty": 1.0, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 16, "group": 6, "node_size": 13, "heteroblasty": 0.515, "pieChart": [{"color": 4, "percent": 15.385}, {"color": 6, "percent": 84.615}]}, {"id": 17, "group": 6, "node_size": 14, "heteroblasty": 0.597, "pieChart": [{"color": 4, "percent": 28.571}, {"color": 5, "percent": 7.143}, {"color": 6, "percent": 64.286}]}, {"id": 18, "group": 6, "node_size": 13, "heteroblasty": 0.641, "pieChart": [{"color": 4, "percent": 15.385}, {"color": 5, "percent": 7.692}, {"color": 6, "percent": 76.923}]}, {"id": 19, "group": 6, "node_size": 18, "heteroblasty": 0.742, "pieChart": [{"color": 4, "percent": 22.222}, {"color": 6, "percent": 77.778}]}, {"id": 20, "group": 4, "node_size": 115, "heteroblasty": 0.112, "pieChart": [{"color": 4, "percent": 58.261}, {"color": 5, "percent": 14.783}, {"color": 6, "percent": 26.957}]}, {"id": 21, "group": 4, "node_size": 103, "heteroblasty": 0.182, "pieChart": [{"color": 4, "percent": 60.194}, {"color": 5, "percent": 16.505}, {"color": 6, "percent": 23.301}]}, {"id": 22, "group": 4, "node_size": 133, "heteroblasty": 0.245, "pieChart": [{"color": 4, "percent": 57.895}, {"color": 5, "percent": 15.038}, {"color": 6, "percent": 27.068}]}, {"id": 23, "group": 4, "node_size": 138, "heteroblasty": 0.315, "pieChart": [{"color": 4, "percent": 57.246}, {"color": 5, "percent": 15.942}, {"color": 6, "percent": 26.812}]}, {"id": 24, "group": 4, "node_size": 112, "heteroblasty": 0.381, "pieChart": [{"color": 4, "percent": 60.714}, {"color": 5, "percent": 14.286}, {"color": 6, "percent": 25.0}]}, {"id": 25, "group": 4, "node_size": 116, "heteroblasty": 0.455, "pieChart": [{"color": 4, "percent": 58.621}, {"color": 5, "percent": 15.517}, {"color": 6, "percent": 25.862}]}, {"id": 26, "group": 4, "node_size": 130, "heteroblasty": 0.518, "pieChart": [{"color": 4, "percent": 60.0}, {"color": 5, "percent": 16.923}, {"color": 6, "percent": 23.077}]}, {"id": 27, "group": 4, "node_size": 112, "heteroblasty": 0.587, "pieChart": [{"color": 4, "percent": 61.607}, {"color": 5, "percent": 16.071}, {"color": 6, "percent": 22.321}]}, {"id": 28, "group": 4, "node_size": 116, "heteroblasty": 0.793, "pieChart": [{"color": 4, "percent": 62.069}, {"color": 5, "percent": 16.379}, {"color": 6, "percent": 21.552}]}, {"id": 29, "group": 4, "node_size": 132, "heteroblasty": 0.867, "pieChart": [{"color": 4, "percent": 59.091}, {"color": 5, "percent": 15.152}, {"color": 6, "percent": 25.758}]}, {"id": 30, "group": 4, "node_size": 146, "heteroblasty": 0.954, "pieChart": [{"color": 4, "percent": 58.904}, {"color": 5, "percent": 16.438}, {"color": 6, "percent": 24.658}]}, {"id": 31, "group": 4, "node_size": 2, "heteroblasty": 0.675, "pieChart": [{"color": 4, "percent": 100.0}]}, {"id": 32, "group": 6, "node_size": 2, "heteroblasty": 0.457, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 33, "group": 6, "node_size": 2, "heteroblasty": 0.7, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 34, "group": 6, "node_size": 2, "heteroblasty": 0.58, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 35, "group": 6, "node_size": 2, "heteroblasty": 0.787, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 36, "group": 6, "node_size": 2, "heteroblasty": 0.668, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 37, "group": 6, "node_size": 3, "heteroblasty": 0.87, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 38, "group": 6, "node_size": 2, "heteroblasty": 0.905, "pieChart": [{"color": 6, "percent": 100.0}]}, {"id": 39, "group": 5, "node_size": 2, "heteroblasty": 0.192, "pieChart": [{"color": 5, "percent": 100.0}]}], "links": [{"source": 0, "target": 1, "value": 4}, {"source": 0, "target": 21, "value": 1}, {"source": 0, "target": 39, "value": 1}, {"source": 1, "target": 2, "value": 5}, {"source": 1, "target": 22, "value": 3}, {"source": 2, "target": 3, "value": 4}, {"source": 2, "target": 21, "value": 1}, {"source": 2, "target": 23, "value": 1}, {"source": 2, "target": 39, "value": 1}, {"source": 3, "target": 4, "value": 3}, {"source": 3, "target": 5, "value": 1}, {"source": 3, "target": 22, "value": 1}, {"source": 3, "target": 24, "value": 1}, {"source": 4, "target": 6, "value": 6}, {"source": 4, "target": 7, "value": 1}, {"source": 4, "target": 25, "value": 3}, {"source": 4, "target": 32, "value": 1}, {"source": 5, "target": 6, "value": 1}, {"source": 6, "target": 16, "value": 5}, {"source": 7, "target": 8, "value": 1}, {"source": 8, "target": 9, "value": 3}, {"source": 9, "target": 10, "value": 1}, {"source": 10, "target": 11, "value": 57}, {"source": 10, "target": 27, "value": 49}, {"source": 11, "target": 12, "value": 4}, {"source": 11, "target": 18, "value": 2}, {"source": 11, "target": 28, "value": 54}, {"source": 11, "target": 33, "value": 2}, {"source": 12, "target": 13, "value": 7}, {"source": 12, "target": 19, "value": 12}, {"source": 12, "target": 29, "value": 5}, {"source": 12, "target": 37, "value": 1}, {"source": 13, "target": 14, "value": 12}, {"source": 13, "target": 30, "value": 3}, {"source": 13, "target": 35, "value": 1}, {"source": 16, "target": 17, "value": 4}, {"source": 16, "target": 25, "value": 2}, {"source": 16, "target": 32, "value": 1}, {"source": 16, "target": 34, "value": 1}, {"source": 17, "target": 18, "value": 7}, {"source": 17, "target": 26, "value": 1}, {"source": 17, "target": 31, "value": 1}, {"source": 17, "target": 36, "value": 1}, {"source": 18, "target": 19, "value": 3}, {"source": 18, "target": 34, "value": 1}, {"source": 19, "target": 31, "value": 1}, {"source": 19, "target": 35, "value": 1}, {"source": 19, "target": 36, "value": 1}, {"source": 20, "target": 21, "value": 43}, {"source": 21, "target": 22, "value": 58}, {"source": 22, "target": 23, "value": 71}, {"source": 23, "target": 24, "value": 66}, {"source": 24, "target": 25, "value": 45}, {"source": 25, "target": 26, "value": 66}, {"source": 26, "target": 27, "value": 63}, {"source": 28, "target": 29, "value": 62}, {"source": 29, "target": 30, "value": 65}, {"source": 37, "target": 38, "value": 2}]}]
    

        var link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(graph.links)
                .enter().append("line")
                .attr("stroke-width", function (d) {
                    return Math.pow(d.value,0.65)+3;
                });

        var node = g.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(graph.nodes)
                .enter()
                .append("g")
                
                .on("mouseover", function(d) {
   tooltip.html("<b> Node ID: </b>" + d.id + "<br/>"+"<b> Majority Species: </b>" + d.group + "<br/>"+ "<b> Lens value: </b>" + Math.round(d.heteroblasty*10000)/10000);
    tooltip.append("img")
      .attr("src", "node_avg_outline/" + d.id + ".png")
//      .attr("x", -8)
//      .attr("y", -8)
      .attr("width", "150px")
      .attr("height", "150px");
    tooltip.style("visibility", "visible");
  })
  .on("mousemove", function() {
    return tooltip.style("top", (event.pageY -
      10) + "px").style("left", (event.pageX + 10) + "px");
  })
  .on("mouseout", function() {
    return tooltip.style("visibility", "hidden");
  });



        /* Draw the respective pie chart for each node */
        node.each(function (d) {
            NodePieBuilder.drawNodePie(d3.select(this), d.pieChart, {
                parentNodeColor: color(d.group),
                outerStrokeWidth: Math.sqrt(d.node_size)+5,
                showLabelText: false,
                radius: Math.pow(d.node_size,0.6)+10,             
                labelText: d.id,
                labelColor: color(d.group)
            });
        });

        simulation
                .nodes(graph.nodes)
                .on("tick", ticked);

        simulation.force("link")
                .links(graph.links);
                
    //add drag capabilities  
    var drag_handler = d3.drag()
	.on("start", dragstarted)
	.on("drag", dragged)
	.on("end", dragended);	
	
    drag_handler(node);    


    //add zoom capabilities 
    var zoom_handler = d3.zoom()
        .on("zoom", zoom_actions);
        
//        var zoom_handler = d3.zoom()
//        .on("zoom", zoom_actions, function(){
//    svg.attr("transform", d3.event.transform);
//});

    zoom_handler(svg);  
    
    resize();
    d3.select(window).on("resize", resize);   

        function ticked() {
            link
                    .attr("x1", function (d) {
                        return d.source.x;
                    })
                    .attr("y1", function (d) {
                        return d.source.y;
                    })
                    .attr("x2", function (d) {
                        return d.target.x;
                    })
                    .attr("y2", function (d) {
                        return d.target.y;
                    });

            d3.selectAll("circle").attr("cx", function (d) {
                        return d.x;
                    })
                    .attr("cy", function (d) {
                        return d.y;
                    });

            d3.selectAll("text").attr("x", function (d) {
                        return d.x;
                    })
                    .attr("y", function (d) {
                        return d.y;
                    });
        }
        
          node.append("title")
      .text(function(d) { return d.name; });


    var sequentialScale = d3.scaleOrdinal(d3.schemeCategory10)
      .domain(['A', 'B', 'C', 'D', 'E', 'F', 'G']);
  
    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

  
    var svg = d3.select("svg");

    svg.append("g")
      .attr("class", "legendSequential")
      .attr("transform", "translate("+(width+10)+","+(height+20)+")");
      

    var legendSequential = d3.legendColor()
      .shapeWidth(30)
      .cells(7)
      .orient("vertical")
		.title("Morphotype")
		.titleWidth(100)
      .scale(sequentialScale) 
      
      

    svg.select(".legendSequential")
      .call(legendSequential); 
      
	    function dragstarted(d) {
		if (!d3.event.active) simulation.alphaTarget(0.3).restart();
		d.fx = d.x;
		d.fy = d.y;
	    }

	    function dragged(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
	    }

	    function dragended(d) {
		if (!d3.event.active) simulation.alphaTarget(0);
		d.fx = null;
		d.fy = null;
	    }
	    
	    //Zoom functions 
	    function zoom_actions(){
		g.attr("transform", d3.event.transform)
	    }


	    function tickActions() {
	    //update circle positions each tick of the simulation 
	       node
		.attr("cx", function(d) { return d.x; })
		.attr("cy", function(d) { return d.y; });
		
	    //update link positions 
	    link
		.attr("x1", function(d) { return d.source.x; })
		.attr("y1", function(d) { return d.source.y; })
		.attr("x2", function(d) { return d.target.x; })
		.attr("y2", function(d) { return d.target.y; });
	    } 
	    
	      function resize() {
	    width = window.innerWidth, height = window.innerHeight;
	    svg.attr("width", width).attr("height", height);
	    force.size([width, height]).resume();
  }

    
</script>
